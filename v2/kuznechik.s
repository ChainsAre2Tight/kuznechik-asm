    // .section	.rodata
	.align 32
	.type	LinearLookup, @object
	.size	LinearLookup, 2048
LinearLookup:
	.string	""
	.ascii	"\224\353\177\025\201\376j*\276\301U?\253\324@T\300\277+A\325"
	.ascii	"\252>~\352\225\001k\377\200\024\250<C\327\275)V\302\202\026i"
	.ascii	"\375\227\003|\350\374h\027\203\351}\002\226\326B=\251\303W(\274"
	.ascii	"\223\007x\354\206\022m\371\271-R\306\2548G\323\307S,\270\322"
	.ascii	"F9\255\355y\006\222\370l\023\207;\257\320D.\272\305Q\021\205"
	.ascii	"\372n\004\220\357{o\373\204\020z\356\221\005E\321\256:P\304\273"
	.ascii	"/\345q\016\232\360d\033\217\317[$\260\332N1\245\261%Z\316\244"
	.ascii	"0O\333\233\017p\344\216\032e\361M\331\2462X\314\263'g\363\214"
	.ascii	"\030r\346\231\r\031\215\362f\f\230\347s3\247\330L&\262\315Yv"
	.ascii	"\342\235\tc\367\210\034\\\310\267#I\335\2426\"\266\311]7\243"
	.ascii	"\334H\b\234\343w\035\211\366b\336J5\241\313_ \264\364`\037\213"
	.ascii	"\341u\n\236\212\036a\365\237\013t\340\2404K\337\265!^\312"
	.string	""
	.ascii	" @`\200\240\300\340\303\343\203\243Cc\003#Ee\005%\305\345\205"
	.ascii	"\245\206\246\306\346\006&Ff\212\252\312\352\n*JjIi\t)\311\351"
	.ascii	"\211\251\317\357\217\257Oo\017/\f,Ll\214\254\314\354\327\367"
	.ascii	"\227\267Ww\0277\0244Tt\224\264\324\364\222\262\322\362\0222R"
	.ascii	"rQq\0211\321\361\221\261]}\035=\335\375\235\275\236\276\336\376"
	.ascii	"\036>^~\0308Xx\230\270\330\370\333\373\233\273[{\033;mM-\r\355"
	.ascii	"\315\255\215\256\216\356\316.\016nN(\bhH\250\210\350\310\353"
	.ascii	"\313\253\213kK+\013\347\307\247\207gG'\007$\004dD\244\204\344"
	.ascii	"\304\242\202\342\302\"\002bBaA!\001\341\301\241\201\272\232\372"
	.ascii	"\332:\032zZyY9\031\371\331\271\231\377\337\277\237\177_?\037"
	.ascii	"<\034|\\\274\234\374\3340\020pP\260\220\360\320\363\323\263\223"
	.ascii	"sS3\023uU5\025\365\325\265\225\266\226\366\3266\026vV"
	.string	""
	.ascii	"\205\311LQ\324\230\035\242'k\356\363v:\277\207\002N\313\326S"
	.ascii	"\037\232%\240\354it\361\2758\315H\004\201\234\031U\320o\352\246"
	.ascii	"#>\273\367rJ\317\203\006\033\236\322W\350m!\244\271<p\365Y\334"
	.ascii	"\220\025\b\215\301D\373~2\267\252/c\346\336[\027\222\217\nF\303"
	.ascii	"|\371\2650-\250\344a\224\021]\330\305@\f\2116\263\377zg\342\256"
	.ascii	"+\023\226\332_B\307\213\016\2614x\375\340e)\254\2627{\376\343"
	.ascii	"f*\257\020\225\331\\A\304\210\r5\260\374yd\341\255(\227\022^"
	.ascii	"\333\306C\017\212\177\372\2663.\253\347b\335X\024\221\214\tE"
	.ascii	"\300\370}1\264\251,`\345Z\337\223\026\013\216\302G\353n\"\247"
	.ascii	"\272?s\366I\314\200\005\030\235\321Tl\351\245 =\270\364q\316"
	.ascii	"K\007\202\237\032V\323&\243\357jw\362\276;\204\001M\310\325P"
	.ascii	"\034\231\241$h\355\360u9\274\003\206\312OR\327\233\036"
	.string	""
	.ascii	"\020 0@P`p\200\220\240\260\300\320\340\360\303\323\343\363\203"
	.ascii	"\223\243\263CScs\003\023#3EUeu\005\025%5\305\325\345\365\205"
	.ascii	"\225\245\265\206\226\246\266\306\326\346\366\006\026&6FVfv\212"
	.ascii	"\232\252\272\312\332\352\372\n\032*:JZjzIYiy\t\031)9\311\331"
	.ascii	"\351\371\211\231\251\271\317\337\357\377\217\237\257\277O_o\177"
	.ascii	"\017\037/?\f\034,<L\\l|\214\234\254\274\314\334\354\374\327\307"
	.ascii	"\367\347\227\207\267\247WGwg\027\0077'\024\0044$TDtd\224\204"
	.ascii	"\264\244\324\304\364\344\222\202\262\242\322\302\362\342\022"
	.ascii	"\0022\"RBrbQAqa\021\0011!\321\301\361\341\221\201\261\241]M}"
	.ascii	"m\035\r=-\335\315\375\355\235\215\275\255\236\216\276\256\336"
	.ascii	"\316\376\356\036\016>.^N~n\030\b8(XHxh\230\210\270\250\330\310"
	.ascii	"\370\350\333\313\373\353\233\213\273\253[K{k\033\013;+"
	.string	""
	.ascii	"\302G\205\216L\311\013\337\035\230ZQ\223\026\324}\277:\370\363"
	.ascii	"1\264v\242`\345',\356k\251\3728\275\177t\2663\361%\347b\240\253"
	.ascii	"i\354.\207E\300\002\t\313N\214X\232\037\335\326\024\221S7\365"
	.ascii	"p\262\271{\376<\350*\257mf\244!\343J\210\r\317\304\006\203A\225"
	.ascii	"W\322\020\033\331\\\236\315\017\212HC\201\004\306\022\320U\227"
	.ascii	"\234^\333\031\260r\3675>\374y\273o\255(\352\341#\246dn\254)\353"
	.ascii	"\340\"\247e\261s\3664?\375x\272\023\321T\226\235_\332\030\314"
	.ascii	"\016\213IB\200\005\307\224V\323\021\032\330]\237K\211\f\316\305"
	.ascii	"\007\202@\351+\256lg\245 \3426\364q\263\270z\377=Y\233\036\334"
	.ascii	"\327\025\220R\206D\301\003\b\312O\215$\346c\241\252h\355/\373"
	.ascii	"9\274~u\2672\360\243a\344&-\357j\250|\276;\371\3620\265w\336"
	.ascii	"\034\231[P\222\027\325\001\303F\204\217M\310\n"
	.string	""
	.ascii	"\300C\203\206F\305\005\317\017\214LI\211\n\312]\235\036\336\333"
	.ascii	"\033\230X\222R\321\021\024\324W\227\272z\3719<\374\177\277u\265"
	.ascii	"6\366\3633\260p\347'\244da\241\"\342(\350k\253\256n\355-\267"
	.ascii	"w\36441\361r\262x\270;\373\376>\275}\352*\251il\254/\357%\345"
	.ascii	"f\246\243c\340 \r\315N\216\213K\310\b\302\002\201AD\204\007\307"
	.ascii	"P\220\023\323\326\026\225U\237_\334\034\031\331Z\232\255m\356"
	.ascii	".+\353h\250b\242!\341\344$\247g\3600\263sv\2665\365?\377|\274"
	.ascii	"\271y\372:\027\327T\224\221Q\322\022\330\030\233[^\236\035\335"
	.ascii	"J\212\t\311\314\f\217O\205E\306\006\003\303@\200\032\332Y\231"
	.ascii	"\234\\\337\037\325\025\226VS\223\020\320G\207\004\304\301\001"
	.ascii	"\202B\210H\313\013\016\316M\215\240`\343#&\346e\245o\257,\354"
	.ascii	"\351)\252j\375=\276~{\2738\3702\362q\261\264t\3677"
	.string	""
	.ascii	"\001\002\003\004\005\006\007\b\t\n\013\f\r\016\017\020\021\022"
	.ascii	"\023\024\025\026\027\030\031\032\033\034\035\036\037 !\"#$%&"
	.ascii	"'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`a"
	.ascii	"bcdefghijklmnopqrstuvwxyz{|}~\177\200\201\202\203\204\205\206"
	.ascii	"\207\210\211\212\213\214\215\216\217\220\221\222\223\224\225"
	.ascii	"\226\227\230\231\232\233\234\235\236\237\240\241\242\243\244"
	.ascii	"\245\246\247\250\251\252\253\254\255\256\257\260\261\262\263"
	.ascii	"\264\265\266\267\270\271\272\273\274\275\276\277\300\301\302"
	.ascii	"\303\304\305\306\307\310\311\312\313\314\315\316\317\320\321"
	.ascii	"\322\323\324\325\326\327\330\331\332\333\334\335\336\337\340"
	.ascii	"\341\342\343\344\345\346\347\350\351\352\353\354\355\356\357"
	.ascii	"\360\361\362\363\364\365\366\367\370\371\372\373\374\375\376"
	.ascii	"\377"
	.string	""
	.ascii	"\3735\316j\221_\244\324/\341\032\276E\213pk\220^\245\001\372"
	.ascii	"4\317\277D\212q\325.\340\033\326-\343\030\274G\211r\002\3717"
	.ascii	"\314h\223]\246\275F\210s\327,\342\031i\222\\\247\003\3706\315"
	.ascii	"o\224Z\241\005\3760\313\273@\216u\321*\344\037\004\3771\312n"
	.ascii	"\225[\240\320+\345\036\272A\217t\271B\214w\323(\346\035m\226"
	.ascii	"X\243\007\3742\311\322)\347\034\270C\215v\006\3753\310l\227Y"
	.ascii	"\242\336%\353\020\264O\201z\n\361?\304`\233U\256\265N\200{\337"
	.ascii	"$\352\021a\232T\257\013\360>\305\b\363=\306b\231W\254\334'\351"
	.ascii	"\022\266M\203xc\230V\255\t\362<\307\267L\202y\335&\350\023\261"
	.ascii	"J\204\177\333 \356\025e\236P\253\017\364:\301\332!\357\024\260"
	.ascii	"K\205~\016\365;\300d\237Q\252g\234R\251\r\3668\303\263H\206}"
	.ascii	"\331\"\354\027\f\3679\302f\235S\250\330#\355\026\262I\207|"
.align 32
SBox:
	.ascii "\xfc\xee\xdd\x11\xcf\x6e\x31\x16\xfb\xc4\xfa\xda\x23\xc5\x04\x4d"
    .ascii "\xe9\x77\xf0\xdb\x93\x2e\x99\xba\x17\x36\xf1\xbb\x14\xcd\x5f\xc1"
    .ascii "\xf9\x18\x65\x5a\xe2\x5c\xef\x21\x81\x1c\x3c\x42\x8b\x01\x8e\x4f"
    .ascii "\x05\x84\x02\xae\xe3\x6a\x8f\xa0\x06\x0b\xed\x98\x7f\xd4\xd3\x1f"
    .ascii "\xeb\x34\x2c\x51\xea\xc8\x48\xab\xf2\x2a\x68\xa2\xfd\x3a\xce\xcc"
    .ascii "\xb5\x70\x0e\x56\x08\x0c\x76\x12\xbf\x72\x13\x47\x9c\xb7\x5d\x87"
    .ascii "\x15\xa1\x96\x29\x10\x7b\x9a\xc7\xf3\x91\x78\x6f\x9d\x9e\xb2\xb1"
    .ascii "\x32\x75\x19\x3d\xff\x35\x8a\x7e\x6d\x54\xc6\x80\xc3\xbd\x0d\x57"
    .ascii "\xdf\xf5\x24\xa9\x3e\xa8\x43\xc9\xd7\x79\xd6\xf6\x7c\x22\xb9\x03"
    .ascii "\xe0\x0f\xec\xde\x7a\x94\xb0\xbc\xdc\xe8\x28\x50\x4e\x33\x0a\x4a"
    .ascii "\xa7\x97\x60\x73\x1e\x00\x62\x44\x1a\xb8\x38\x82\x64\x9f\x26\x41"
    .ascii "\xad\x45\x46\x92\x27\x5e\x55\x2f\x8c\xa3\xa5\x7d\x69\xd5\x95\x3b"
    .ascii "\x07\x58\xb3\x40\x86\xac\x1d\xf7\x30\x37\x6b\xe4\x88\xd9\xe7\x89"
    .ascii "\xe1\x1b\x83\x49\x4c\x3f\xf8\xfe\x8d\x53\xaa\x90\xca\xd8\x85\x61"
    .ascii "\x20\x71\x67\xa4\x2d\x2b\x09\x5b\xcb\x9b\x25\xd0\xbe\xe5\x6c\x52"
    .ascii "\x59\xa6\x74\xd2\xe6\xf4\xb4\xc0\xd1\x66\xaf\xc2\x39\x4b\x63\xb6"

.globl encrypt
.type encrypt @function
encrypt:
    # rdi - pointer to src
    # rsi - pointer to dst
    # rdx - pointer to round keys

    pushq %rdi                          # save pointer to src
    pushq %rdx                          # save pointer to keys
    pushq %rsi                          # save pointer to dst

    leaq LinearLookup(%rip), %r11       # load Linear Lookup table address into r11
    leaq SBox(%rip), %r10               # load SBox table address into r10
    
    movq 8(%rdi), %rsi                  # move second half of block into rsi
    movq (%rdi), %rdi                   # move first half of block into rdi

                                        # XSL
    movq $9, %rcx                       # set round counter to 9
round_loop:
                                        # X(block, round key) TODO: benchmark against sse2 variant
    movq (%rdx), %r8                    # load first half of round key into r8
    movq 8(%rdx), %r9                   # load second half of round key into r9
    xorq %r8, %rdi                      # XOR first halves of block and key
    xorq %r9, %rsi                      # XOR second halves of block and key

                                        # S(block[0:8])
    movq $8, %r8                        # set sbox counter to 8
sbox_left_loop:
    movzxb %dil, %r9                    # get a byte from left half of the block
    movb (%r10, %r9, 1), %dil           # use sbox table to substitute that byte
    rorq $8, %rdi                       # rotate register 1 byte to the right
    subq $1, %r8                        # repeat 8 times
    jnz sbox_left_loop

    movq $8, %r8                        # same for the right half
sbox_right_loop:
    movzxb %sil, %r9
    movb (%r10, %r9, 1), %sil
    rorq $8, %rsi
    subq $1, %r8
    jnz sbox_right_loop
                                        # L(block)
    movq $16, %r8                       # set iteration counter to 16
L_loop:
                                        # linear(block)
    xorq %rax, %rax                     # empty rax, it will store cumulative xor
    xorq %rbx, %rbx

                                        # left half of the block
    // # LinearLookup[0][array[0]] ^
    movzxb %dil, %r9                    # get a byte from left part of the block
    xorb 0x000(%r11, %r9, 1), %al       # use Linear Lookup to multiply that byte and xor it with rax
    rorq $8, %rdi                       # rotate left part by one byte

    // # LinearLookup[1][array[1]] ^
    movzxb %dil, %r9
    xorb 0x100(%r11, %r9, 1), %al
    rorq $8, %rdi

    // // LinearLookup[2][array[2]] ^
    movzxb %dil, %r9
    xorb 0x200(%r11, %r9, 1), %al
    rorq $8, %rdi

    // // LinearLookup[3][array[3]] ^
    movzxb %dil, %r9
    xorb 0x300(%r11, %r9, 1), %al
    rorq $8, %rdi

    // // LinearLookup[4][array[4]] ^
    movzxb %dil, %r9
    xorb 0x400(%r11, %r9, 1), %al
    rorq $8, %rdi

    // // LinearLookup[5][array[5]] ^
    movzxb %dil, %r9
    xorb 0x500(%r11, %r9, 1), %al
    rorq $8, %rdi

    // // LinearLookup[6][array[6]] ^
    movzxb %dil, %r9
    xorb 0x600(%r11, %r9, 1), %al
    rorq $8, %rdi

    // LinearLookup[7][array[7]] ^
    movzxb %dil, %r9
    xorb 0x700(%r11, %r9, 1), %al
    rorq $8, %rdi

                                        # right half of the block
    // // LinearLookup[6][array[8]] ^
    movzxb %sil, %r9
    xorb 0x600(%r11, %r9, 1), %bl
    rorq $8, %rsi

    // LinearLookup[5][array[9]] ^
    movzxb %sil, %r9
    xorb 0x500(%r11, %r9, 1), %bl
    rorq $8, %rsi

    // // LinearLookup[4][array[10]] ^
    movzxb %sil, %r9
    xorb 0x400(%r11, %r9, 1), %bl
    rorq $8, %rsi

    // // LinearLookup[3][array[11]] ^
    movzxb %sil, %r9
    xorb 0x300(%r11, %r9, 1), %bl
    rorq $8, %rsi

    // // LinearLookup[2][array[12]] ^
    movzxb %sil, %r9
    xorb 0x200(%r11, %r9, 1), %bl
    rorq $8, %rsi

    // // LinearLookup[1][array[13]] ^
    movzxb %sil, %r9
    xorb 0x100(%r11, %r9, 1), %bl
    rorq $8, %rsi

    // // LinearLookup[0][array[14]] ^
    movzxb %sil, %r9
    xorb (%r11, %r9, 1), %bl
    rorq $8, %rsi

    // LinearLookup[6][array[15]]
    movzxb %sil, %r9
    xorb 0x600(%r11, %r9, 1), %bl
    rorq $8, %rsi

    xorb %bl, %al
    
                                        # R, left byteshift
    shlq $56, %rax                      # shift %al 7 bits to the left, so it becomes MSB of rax
    shldq $8, %rdi, %rsi                # shift left half of the block to the left, using MSB of right half to fill zeroes
    shldq $8, %rax, %rdi                # shift right half of the block to the left, using RAZ to fill
    subq $1, %r8                        # decrement L iteration counter
    jnz L_loop

    addq $16, %rdx                      # each round, use next round key
    subq $1, %rcx                       # decrement round counter
    jnz round_loop

                                        # last round, only xor
    movq (%rdx), %r8
    movq 8(%rdx), %r9
    xorq %r8, %rdi
    xorq %r9, %rsi

                                        # copy to dst
    pop %rax                            # restore pointer to dst from stack
    movq %rdi, (%rax)                   # move left half to dst
    movq %rsi, 8(%rax)                  # move right half to dst+8

    pop %rdx                            # restore pointer to round keys
    pop %rdi                            # restore pointer to src
    ret
